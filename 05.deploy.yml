---
- name: Deploy application
  hosts: deploy
  become: yes
  vars:
    artifact_url: "http://34.201.66.66:8081/nexus/content/repositories/releases/com/web/cal/WebAppCal/0.0.6/WebAppCal-0.0.6.war"
    tomcat_webapps_dir: "/opt/tomcat/webapps"
    local_artifact_path: "{{ tomcat_webapps_dir }}/WebAppCal-0.0.6.war"

  tasks:
    - name: Download artifact from Nexus
      get_url:
        url: "{{ artifact_url }}"
        dest: "{{ local_artifact_path }}"
        mode: '0644'

    - name: Ensure Tomcat webapps directory exists
      file:
        path: "{{ tomcat_webapps_dir }}"
        state: directory

    - name: Restart Tomcat to deploy the new WAR
      service:
        name: tomcat
        state: restarted

    - name: Clean up old artifacts (optional)
      file:
        path: "{{ tomcat_webapps_dir }}/WebAppCal-0.0.6.war"
        state: absent
      when: ansible_date_time.iso8601 | to_datetime | regex_replace('T.*', '') != (ansible_date_time.iso8601 | to_datetime | regex_replace('T.*', ''))  # Example condition for cleanup
