---
- name: Upload artifact to Nexus Repository from Build Server
  hosts: n4
  become: yes

  vars:
    nexus_url: "http://172.31.83.202:8081/nexus"  
    repository: "releases"
    group_id: "com.web.cal"
    artifact_id: "WebAppCal"
    packaging: "war"
    nexus_username: "admin"
    nexus_password: "admin123"
    artifact_path: "/home/ubuntu/workspace/ansible-project/target"
  
  tasks:
    - name: Get version from pom.xml
      command: mvn help:evaluate -Dexpression=project.version -q -DforceStdout
      args:
        chdir: /home/ubuntu/workspace/ansible-project
      register: mvn_version_output
    
    - name: Set artifact version
      set_fact:
        artifact_version: "{{ mvn_version_output.stdout.strip() }}"

    - name: Print artifact version
      debug:
        msg: "Artifact version is: {{ artifact_version }}"

    - name: Check if the WAR file exists
      stat:
        path: "{{ artifact_path }}/WebAppCal-{{ artifact_version }}.war"
      register: war_file_check

    - name: Fail if the WAR file does not exist
      fail:
        msg: "WAR file not found: {{ artifact_path }}/WebAppCal-{{ artifact_version }}.war"
      when: not war_file_check.stat.exists

    - name: Print the full path of the WAR file
      debug:
        msg: "Full path to WAR file: {{ artifact_path }}/WebAppCal-{{ artifact_version }}.war"

    - name: Read the WAR file to ensure it's accessible
      command: cat "{{ artifact_path }}/WebAppCal-{{ artifact_version }}.war"
      register: file_contents

    - name: Print the beginning of the WAR file contents
      debug:
        msg: "{{ file_contents.stdout[:1000] }}"


    - name: Upload artifact to Nexus
      uri:
        url: "{{ nexus_url }}/service/local/artifact/maven/content"
        method: POST
        user: "{{ nexus_username }}"
        password: "{{ nexus_password }}"
        force_basic_auth: yes
        body_format: form-multipart
        body:
          r: "{{ repository }}"
          g: "{{ group_id }}"
          a: "{{ artifact_id }}"
          v: "{{ artifact_version }}"
          p: "{{ packaging }}"
          file: "@{{ artifact_path }}/WebAppCal-{{ artifact_version }}.war"
        status_code: 201
      when: war_file_check.stat.exists
